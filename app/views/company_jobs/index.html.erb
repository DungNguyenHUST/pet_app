<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"/>
    </head>

    <body>
        <div class="search_index">
            <div class="container">
                <div class="company_search">
                    <div class="company_label">
                        <%if @companies != nil%>
                            <span>Tìm thấy <%=@companies.count%> công ty</span>
                        <%else%>
                            <strong>Không tìm được kết quả phù hợp</strong>
                        <%end%>
                    </div>

                    <div class="row">
                        <%if @companies != nil%>
                            <% @companies.each do |company| %>
                                <div class="col-sm-3">
                                    <div class="single_company">
                                    <div class="company_wall">
                                        <div class="rounded">
                                            <%if company.wall_picture.attached?%>
                                                <%= link_to (image_tag(company.wall_picture)), image_path(url_for(company.wall_picture)), rel: "gallery" , :href => company_path(company)%>
                                            <%end%>
                                        </div>
                                    </div>

                                    <div class="company_thumbnail">
                                        <div class="rounded">
                                            <%if company.avatar.attached?%>
                                                <%= link_to (image_tag(company.avatar)), image_path(url_for(company.avatar)), rel: "gallery" , :href => company_path(company)%>
                                            <%end%>
                                        </div>
                                    </div>

                                    <div class="company_love_button" id ="<%=company.id%>">
                                        <%if logged_in?%>
                                            <% pre_follow = company.company_follows.find { |follow| follow.user_id == current_user.id} %>
                                            <% if pre_follow %> 
                                                <%= link_to '<button class="follow_btn_highlight"><i class="material-icons">favorite</i></button>'.html_safe, company_company_follow_path(company, pre_follow), remote: true, method: :delete%>
                                            <%else%>
                                                <%= link_to '<button class="follow_btn"><i class="material-icons-outlined">favorite_border</i></button>'.html_safe, company_company_follows_path(company), remote: true, method: :post%>
                                            <%end%>
                                        <%else%>
                                            <%= link_to '<button class="follow_btn"><i class="material-icons-outlined">favorite_border</i></button>'.html_safe, login_path%>
                                        <%end%>
                                    </div>
                                    
                                    <div class="company_title">
                                        <div class="company_name">
                                            <a> <%= link_to company.name, company_path(company), class: "company_name_label" %></a>
                                        </div>

                                        <div class="company_rating">
                                            <%# Cal culate rating score %>
                                            <%if(company.company_reviews.count > 0)%>
                                                <%rate_work_env = company.company_reviews.sum('work_env_score').to_f / company.company_reviews.count%>
                                                <%rate_salary = company.company_reviews.sum('salary_score').to_f / company.company_reviews.count%>
                                                <%rate_ot = company.company_reviews.sum('ot_score').to_f / company.company_reviews.count%>
                                                <%rate_manager = company.company_reviews.sum('manager_score').to_f / company.company_reviews.count%>
                                                <%rate_career = company.company_reviews.sum('career_score').to_f / company.company_reviews.count%>
                                                <%total_rate = (rate_work_env + rate_salary + rate_ot + rate_manager + rate_career)/5%>
                                            <%else%>
                                                <%total_rate = 0%>
                                            <%end%>
                                            <div class="review_score_star">
                                                <%if total_rate > 0%>
                                                    <%total_rate.to_i.times do%>
                                                        <i class="material-icons checked">circle</i>
                                                    <%end%>
                                                    <%(5 - total_rate.to_i).to_i.times do%>
                                                        <i class="material-icons checked_out">radio_button_unchecked</i>
                                                    <%end%>
                                                <%else%>
                                                    <%5.times do%>
                                                        <i class="material-icons checked_out">radio_button_unchecked</i>
                                                    <%end%>
                                                <%end%>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="company_summary">

                                        <%# <div class="company_location">
                                            <p><i class="material-icons-outlined">place</i> <%= company.location %></p>
                                        <%# </div> %>

                                        <div class="review_point">

                                            <div class="review_point_review_content">
                                                <a><%= company.company_reviews.count%></a>
                                            </div>

                                            <div class="review_point_review_content">
                                                <a><%= company.company_interviews.count %></a>
                                            </div>

                                            <div class="review_point_review_content">
                                                <a><%= company.company_jobs.count %></a>
                                            </div>

                                            <div class="review_point_label">
                                                <span> <i class="material-icons-outlined">insert_emoticon</i><%= link_to " Đánh giá", company_path(company), class: "review_point_review_label" %></span>
                                            </div>

                                            <div class="review_point_label">
                                                <span> <i class="material-icons-outlined">people_outline</i><%= link_to " Phỏng vấn", company_path(company), class: "review_point_review_label" %></span>
                                            </div>

                                            <div class="review_point_label">
                                                <span> <i class="material-icons-outlined">work_outline</i><%= link_to " Việc làm", company_path(company), class: "review_point_review_label" %></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <%end%>
                        <%end%>
                    </div>
                </div>
            
                <div class="job_search">
                    <div class="job_label">
                        <%if @company_by_jobs != nil%>
                            <span>Tìm thấy <%=@company_by_jobs.count%> việc làm</span>
                        <%else%>
                            <strong>Không tìm được kết quả phù hợp</strong>
                        <%end%>
                    </div>
                    <%if @company_by_jobs != nil%>
                        <% @company_by_jobs.each do |company_by_job| %>
                            <%company_by_job.company_jobs.each do |company_job|%>
                                <div class="user_search_job_block">
                                    <div class="user_job_left">
                                        <div class="company_avatar">
                                            <%if company_by_job.avatar.attached?%>
                                                <%= link_to (image_tag(company_by_job.avatar)), image_path(url_for(company_by_job.avatar)), rel: "gallery" , :href => company_path(company_by_job)%>
                                            <%end%>
                                        </div>
                                    </div>

                                    <div class="user_job_right">
                                        <div class="user_job_des">
                                            <div class="user_job_title">
                                                <a><%= link_to (company_job.title), company_company_job_path(company_by_job, company_job) %></a>
                                            </div>

                                            <div class="user_job_company_name">
                                                <%if(company_by_job.company_reviews.count > 0)%>
                                                    <%rate_work_env = company_by_job.company_reviews.sum('work_env_score').to_f / company_by_job.company_reviews.count%>
                                                    <%rate_salary = company_by_job.company_reviews.sum('salary_score').to_f / company_by_job.company_reviews.count%>
                                                    <%rate_ot = company_by_job.company_reviews.sum('ot_score').to_f / company_by_job.company_reviews.count%>
                                                    <%rate_manager = company_by_job.company_reviews.sum('manager_score').to_f / company_by_job.company_reviews.count%>
                                                    <%rate_career = company_by_job.company_reviews.sum('career_score').to_f / company_by_job.company_reviews.count%>
                                                    <%total_rate = (rate_work_env + rate_salary + rate_ot + rate_manager + rate_career)/5%>
                                                <%else%>
                                                    <%total_rate = 0%>
                                                <%end%>
                                                <a><%= link_to (company_by_job.name), company_path(company_by_job)%> </a>
                                                <a><%=total_rate%><i class="material-icons checked">circle</i></a>
                                            </div>

                                            <div class="user_job_description">
                                                <a><%= company_job.description %></a>
                                            </div>

                                            <div class="user_job_location">
                                                <a><i class="material-icons-outlined">location_on</i><%= company_job.location %></a>
                                            </div>

                                            <div class="user_job_tech">
                                                <a><i class="material-icons-outlined">book</i><%= company_job.category %></a>
                                            </div>

                                            <div class="user_job_salary">
                                                <a><i class="material-icons-outlined">local_offer</i><%= company_job.salary %></a>
                                            </div>

                                            <div class="user_job_date">
                                                <a><%= time_ago_in_words(company_job.created_at) %> • <%= company_job.job_type %></a>
                                            </div>

                                            <%if company_job.urgent%>                
                                                <div class="user_job_hot_save">
                                                    <div class="user_job_hot_label">
                                                        <a>Urgent</a>
                                                    </div>
                                                    
                                                    <div class="user_job_button_save">
                                                        <%if logged_in?%>
                                                            <% pre_save = company_job.company_save_jobs.find { |save| save.user_id == current_user.id} %>
                                                            <% if pre_save %> 
                                                                <%= link_to '<button class="save_btn_highlight"><i class="material-icons">turned_in</i> </button>'.html_safe, company_company_job_company_save_job_path(company.id, company_job.id, pre_save.id), method: :delete%>
                                                            <%else%>
                                                                <%= link_to '<button class="save_btn"><i class="material-icons-outlined">turned_in_not</i> </button>'.html_safe, company_company_job_company_save_jobs_path(company.id, company_job.id), method: :post%>
                                                            <%end%>
                                                        <%else%>
                                                            <%= link_to '<button class="save_btn"><i class="material-icons-outlined">turned_in_not</i> </button>'.html_safe, login_path%>
                                                        <%end%>
                                                    </div>
                                                </div>
                                            <%else%>
                                                <div class="user_job_hot_save_only">
                                                    <div class="user_job_button_save">
                                                        <%if logged_in?%>
                                                            <% pre_save = company_job.company_save_jobs.find { |save| save.user_id == current_user.id} %>
                                                            <% if pre_save %> 
                                                                <%= link_to '<button class="save_btn_highlight"><i class="material-icons">turned_in</i> </button>'.html_safe, company_company_job_company_save_job_path(company.id, company_job.id, pre_save.id), method: :delete%>
                                                            <%else%>
                                                                <%= link_to '<button class="save_btn"><i class="material-icons-outlined">turned_in_not</i> </button>'.html_safe, company_company_job_company_save_jobs_path(company.id, company_job.id), method: :post%>
                                                            <%end%>
                                                        <%else%>
                                                            <%= link_to '<button class="save_btn"><i class="material-icons-outlined">turned_in_not</i> </button>'.html_safe, login_path%>
                                                        <%end%>
                                                    </div>
                                                </div>   
                                            <%end%>
                                        </div>
                                    </div>
                                </div>
                            <%end%>
                        <%end%>
                    <%end%>
                </div>
            </div>
        </div>
    <body>
<html>